name: iOS Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm install
    
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
        bundler-cache: true
        working-directory: ios
    
    - name: Install CocoaPods dependencies
      run: |
        cd ios
        bundle install
        bundle exec pod install --repo-update
        cd ..
    
    - name: List available schemes
      run: |
        cd ios
        xcodebuild -list -workspace videocalling.xcworkspace || xcodebuild -list -project videocalling.xcodeproj
        cd ..
    
    - name: Build iOS app for Simulator
      run: |
        cd ios
        xcodebuild -workspace videocalling.xcworkspace \
          -scheme videocalling \
          -configuration Release \
          -sdk iphonesimulator \
          -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=latest' \
          -derivedDataPath build \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGNING_REQUIRED=NO \
          ONLY_ACTIVE_ARCH=NO \
          | xcpretty || true
        cd ..
    
    - name: Check build output
      run: |
        echo "Checking build output..."
        ls -la ios/build/Build/Products/ || echo "Build products not found"
        find ios/build -name "*.app" -type d || echo "No .app found"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      if: success()
      with:
        name: ios-simulator-build
        path: ios/build/Build/Products/Release-iphonesimulator/
        retention-days: 7
    
    - name: Build summary
      if: success()
      run: |
        echo "‚úÖ iOS build completed successfully!"
        echo "üì± Build artifacts are available in the Actions tab"
        echo "üîç This is a SIMULATOR build (no code signing required)"
        echo "üì¶ Download the artifact to test on macOS with iOS Simulator"
    
    - name: Build failed summary
      if: failure()
      run: |
        echo "‚ùå iOS build failed!"
        echo "üìã Check the logs above for details"
        echo "üí° Common issues:"
        echo "   - CocoaPods dependencies"
        echo "   - Missing scheme"
        echo "   - Build configuration errors"
